<Project DefaultTargets="LzoAndZLib" ToolsVersion="4.0"
    xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<LzoFile>lzo-2.09</LzoFile>
		<LzoUrl>http://www.oberhumer.com/opensource/lzo/download/$(LzoFile).tar.gz</LzoUrl>
		<ZLibFile>zlib-1.2.8</ZLibFile>
		<ZLibUrl>http://zlib.net/$(ZLibFile).tar.gz</ZLibUrl>
	</PropertyGroup>
	<ItemGroup>
		<CSFile 
			Include="Builder\*.cs; Builder\Tar\*.cs" />
	</ItemGroup>
	<Target Name="All">
		<CallTarget Targets="LzoAndZLib" />
		<CallTarget Targets="LibBarn" />
		<CallTarget Targets="Sheep" />
		<CallTarget Targets="Browser" />
		<CallTarget Targets="LevelViewer" />
	</Target>
	<Target Name="LzoAndZLib">
	
		<MakeDir
			Directories="Lib"
		/>
	
		<Message Text="Building the Magic Tool..." />
		<Csc 
			Sources="@(CSFile)"
			OutputAssembly="Builder.exe"
		/>
		
		<!-- downloading ZLib -->
		<Message Text="Downloading ZLib..." />
		<Exec
			Command="Builder.exe -d $(ZLibUrl)"
		/>
		
		<Move
			SourceFiles="$(ZLibFile).tar.gz"
			DestinationFolder="Lib"
		/>
		
		<!-- Extract ZLib -->
		<Message Text="Extracting ZLib..." />
		<Exec
			Command="..\Builder.exe -x $(ZLibFile).tar.gz"
			WorkingDirectory="Lib"
		/>
		
		<CallTarget Targets="BuildZLib" />
		
		<!-- Copy the output -->
		<CallTarget Targets="CopyLZOAndZLib" />
		
		<Message Text="All done!" />
	</Target>
	<Target Name="BuildZLib">
		<!-- Building ZLib -->
		<Message Text="Building ZLib..." />
		<Exec
			Command="bld_ml32.bat"
			WorkingDirectory="Lib\$(ZLibFile)/contrib/masmx86"
		/>
		<Exec
			Command="msbuild zlibstat.vcxproj /p:Configuration=Release"
			WorkingDirectory="Lib\$(ZLibFile)/contrib/vstudio/vc11"
		/>
	</Target>
	<Target Name="CopyLZOAndZLib">
		<Message Text="Copying output..." />
		<Copy
			SourceFiles="Lib\$(ZLibFile)\contrib\vstudio\vc11\x86\ZlibStatRelease\zlibstat.lib"
			DestinationFolder="Lib"
		/>
	</Target>
	<Target Name="LibBarn">
		<MSBuild
			Projects="libbarn/libbarn2015.vcxproj"
			Properties="Configuration=Release"
		/>
	</Target>
	<Target Name="Sheep">
	
		<Copy
			Condition="!Exists('sheep/sheepParser.cpp')"
			SourceFiles="sheep/extra/sheepParser.cpp;sheep/extra/sheepParser.hpp;sheep/extra/sheepScanner.cpp"
			DestinationFolder="sheep"
		/>
	
		<MSBuild
			Projects="sheep/sheep2015.vcxproj"
			Properties="Configuration=Release"
		/>
	</Target>
	<Target Name="Browser"
		DependsOnTargets="LibBarn;Sheep">
		<MSBuild
			Projects="browser/browser2010.csproj"
			Properties="Configuration=Release;Platform=x86"
		/>
		<Copy
			SourceFiles="libbarn/Release/barn.dll;sheep/Release/sheep.dll"
			DestinationFolder="browser/bin/x86/Release"
		/>
	</Target>
	<Target Name="LevelViewer">
		<MSBuild
			Projects="levelviewer/Main/Main2015.csproj"
			Properties="Configuration=Release;Platform=x86"
		/>
		<MSBuild
			Projects="levelviewer/Viewer/Viewer2015.csproj"
			Properties="Configuration=Release;Platform=x86"
		/>
		<MSBuild
			Projects="levelviewer/Game/Game2015.csproj"
			Properties="Configuration=Release;Platform=x86"
		/>
		
		<!-- copy sheep and barn dlls into the output directories -->
		<Copy
			SourceFiles="sheep\Release\sheep.dll;libbarn\Release\barn.dll"
			DestinationFolder="levelviewer\Game\bin\x86\Release"
		/>
		<Copy
			SourceFiles="sheep\Release\sheep.dll;libbarn\Release\barn.dll"
			DestinationFolder="levelviewer\Viewer\bin\x86\Release"
		/>
	</Target>
</Project>
